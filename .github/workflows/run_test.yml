name: Run BDD Tests and Publish Extent Report

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Manual trigger with user inputs
  workflow_dispatch:
    inputs:
      browser:
        description: "Which browser do you want to run the UI tests on?"
        required: false
        default: "chrome"
        type: choice
        options:
          - chrome
          - firefox
          - edge

      category:
        description: "Test Category to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - ui
          - api

      environment:
        description: "Environment to test against"
        required: false
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'   # change to match your framework

    - name: Restore dependencies
      run: dotnet restore

    - name: Build project
      run: dotnet build --configuration Release --no-restore


    # Build the dotnet test command dynamically based on inputs
    - name: Run Tests (Generate Extent Report)
      run: |
        echo "Running tests with:"
        echo "Browser: ${{ github.event.inputs.browser }}"
        echo "Category: ${{ github.event.inputs.category }}"
        echo "Environment: ${{ github.event.inputs.environment }}"
        
        #Defaults when triggered by Push/PR (inputs will be empty)
        BROWSER_VALUE="${{github.event.inputs.browser}}"
        ENV_VALUE="${{github.event.inputs.environment}}"
        CATEGORY_VALUE=${{github.event.inputs.category}}

        # If browser input is empty => default chrome
        if [ -z "$BROWSER_VALUE" ]; then
          BROWSER_VALUE="chrome"
        fi
        # If Env input is empty => default dev
        if [ -z "$ENV_VALUE" ]; then
          ENV_VALUE="dev"
        fi
        # If category filter input is empty => default all
        if [ -z "$CATEGORY_VALUE" ]; then
          ENV_VALUE="all"
        fi

        echo "Using Browser: $BROWSER_VALUE"
        echo "Using Env : $ENV_VALUE"
        echo "Using Filter: $CATEGORY_VALUE"

        # Build category filter
        if [ "${{ github.event.inputs.category }}" = "all" ]; then
          CATEGORY_FILTER=""
        else
          CATEGORY_FILTER="--filter Category=${{ github.event.inputs.category }}"
        fi


        # Export browser + environment as env variables used by the framework
        export BROWSER="$BROWSER_VALUE"
        export ENVIRONMENT="$ENV_VALUE"

        # Execute tests
        dotnet test $CATEGORY_FILTER --configuration Release --no-build

    # âœ” FIXED: Updated artifact action to v4
    - name: Publish Extent HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: ExtentReport
        path: |
          Reports/**/*.html
        retention-days: 7
