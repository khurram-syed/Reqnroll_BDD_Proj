name: Run BDD Tests and Publish Extent Report

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Manual trigger with user inputs
  workflow_dispatch:
    inputs:
      browser:
        description: "Which browser do you want to run the UI tests on?"
        required: false
        default: "chrome"
        type: choice
        options:
          - chrome
          - firefox
          - edge

      category:
        description: "Test Category to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - ui
          - api

      environment:
        description: "Environment to test against"
        required: false
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'   # change to match your framework

    - name: Restore dependencies
      run: dotnet restore

    - name: Build project
      run: dotnet build --configuration Release --no-restore


    - name: Run Tests (Generate Extent Report)
      shell: bash
      run: |
        echo "Running tests with:"
        echo "Browser: '${{ github.event.inputs.browser }}'"
        echo "Category: '${{ github.event.inputs.category }}'"
        echo "Environment: '${{ github.event.inputs.environment }}'"

        # Assign inputs from GitHub workflow_dispatch
        BROWSER_VALUE="${{ github.event.inputs.browser }}"
        CATEGORY_VALUE="${{ github.event.inputs.category }}"
        ENV_VALUE="${{ github.event.inputs.environment }}"

        # Set real defaults when triggered by push/PR
        if [ -z "$BROWSER_VALUE" ]; then
          BROWSER_VALUE="chrome"
        fi
        if [ -z "$ENV_VALUE" ]; then
          ENV_VALUE="dev"
        fi

        # CATEGORY FILTER LOGIC (100% SAFE)
        if [ -z "$CATEGORY_VALUE" ] || [ "$CATEGORY_VALUE" = "all" ]; then
          CATEGORY_FILTER=""
        else
          CATEGORY_FILTER="--filter Category=$CATEGORY_VALUE"
        fi

        echo "Using Browser: $BROWSER_VALUE"
        echo "Using Environment: $ENV_VALUE"
        echo "Using Filter: '$CATEGORY_FILTER'"

        export BROWSER=$BROWSER_VALUE
        export ENVIRONMENT=$ENV_VALUE

        # Safely run dotnet test
        if [ -z "$CATEGORY_FILTER" ]; then
          dotnet test --configuration Release --no-build
        else
          dotnet test $CATEGORY_FILTER --configuration Release --no-build
        fi

    # âœ” FIXED: Updated artifact action to v4
    - name: Publish Extent HTML Report
      uses: actions/upload-artifact@v4
      with:
        name: ExtentReport
        path: |
          Reports/**/*.html
        retention-days: 7
